<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Albumentations provides a comprehensive, high-performance framework for augmenting images to improve machine learning models. Ideal for computer vision applications, supporting a wide range of augmentations."><link href=https://albumentations.ai/docs/examples/pytorch_semantic_segmentation/ rel=canonical><link href=../pytorch_classification/ rel=prev><link href=../replay/ rel=next><link rel=icon href=../../images/logo.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.35"><title>PyTorch and Albumentations for semantic segmentation - Albumentations Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.35f28582.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../css/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-DCXRDR9HJ0"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-DCXRDR9HJ0",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-DCXRDR9HJ0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta property=og:title content="Albumentations Documentation - PyTorch and Albumentations for semantic segmentation"><meta property=og:description content="Albumentations provides a comprehensive, high-performance framework for augmenting images to improve machine learning models. Ideal for computer vision applications, supporting a wide range of augmentations."><meta property=og:image content=https://albumentations.ai/docs/images/albumentations_card.png><meta property=og:image:type content=image/png><meta property=og:type content=website><meta content=https://albumentations.ai/docs/examples/pytorch_semantic_segmentation/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@albumentations><meta name=twitter:creator content=@viglovikov><meta name=twitter:title content="Albumentations Documentation - PyTorch and Albumentations for semantic segmentation"><meta name=twitter:description content="Albumentations provides a comprehensive, high-performance framework for augmenting images to improve machine learning models. Ideal for computer vision applications, supporting a wide range of augmentations."><meta name=twitter:image content=https://albumentations.ai/docs/images/albumentations_card.png><meta name=description content="Albumentations provides a comprehensive, high-performance framework for augmenting images to improve machine learning models. Ideal for computer vision applications, supporting a wide range of augmentations."><meta name=keywords content="Albumentations, image augmentation, machine learning, computer vision, data augmentation, image processing, deep learning, AI, artificial intelligence, Python"></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=white> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#pytorch-and-albumentations-for-semantic-segmentation class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <div class=announce-wrapper> <div id=announce-left> <div class=item> <a class=announce-link target=_blank href=https://github.com/sponsors/albumentations-team> <span class="twemoji twitter"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </span> You can now sponsor <strong>Albumentations</strong> </a> </div> <div class=item> <a class=announce-link href=https://twitter.com/albumentations target=_blank> <span class="twemoji twitter"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg> </span> Follow <strong>@albumentations</strong> on <strong>Twitter</strong> to stay updated </a> </div> <div class=item> <a class=announce-link href=https://www.linkedin.com/company/100504475 target=_blank> <span class="twemoji linkedin"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </span> Follow <strong>@albumentations</strong> on <strong>LinkedIn</strong> to stay updated </a> </div> </div> </div> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <a href=../.. title="Albumentations Documentation" class="md-header__button md-logo" aria-label="Albumentations Documentation" data-md-component=logo> <img src=../../images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> </div> <div class=md-header-nav__title> <div class=header-menu-item> <a href=https://albumentations.ai>Home</a> </div> <div class="header-menu-item header-menu-item-selected"> <a href=https://albumentations.ai/docs/ >Documentation</a> </div> <div class="header-menu-item header-large-menu-item"> <a href=https://albumentations.ai/whos_using>Who's using</a> </div> <div class="header-menu-item header-large-menu-item"> <a href=https://explore.albumentations.ai target=_blank>Explore</a> </div> <div class="header-menu-item header-large-menu-item"> <a href=https://albumentations.ai/people>People</a> </div> </div> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/albumentations-team/albumentations title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> albumentations </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Albumentations Documentation" class="md-nav__button md-logo" aria-label="Albumentations Documentation" data-md-component=logo> <img src=../../images/logo.png alt=logo> </a> Albumentations Documentation </label> <div class=md-nav__source> <a href=https://github.com/albumentations-team/albumentations title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> albumentations </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Documentation </span> </a> </li> <li class=md-nav__item> <a href=../../benchmarking_results/ class=md-nav__link> <span class=md-ellipsis> Benchmarking Results </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Introduction </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../introduction/image_augmentation/ class=md-nav__link> <span class=md-ellipsis> What is image augmentation </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/why_you_need_a_dedicated_library_for_image_augmentation/ class=md-nav__link> <span class=md-ellipsis> Why you need a dedicated library </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/why_albumentations/ class=md-nav__link> <span class=md-ellipsis> Why Albumentations </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Getting started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting_started/installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/image_augmentation/ class=md-nav__link> <span class=md-ellipsis> Image augmentation for classification </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/mask_augmentation/ class=md-nav__link> <span class=md-ellipsis> Mask augmentation for segmentation </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/bounding_boxes_augmentation/ class=md-nav__link> <span class=md-ellipsis> Bounding boxes augmentation for object detection </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/keypoints_augmentation/ class=md-nav__link> <span class=md-ellipsis> Keypoints augmentation </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/simultaneous_augmentation/ class=md-nav__link> <span class=md-ellipsis> Simultaneous augmentation of multiple targets: masks, bounding boxes, keypoints </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/transforms_and_targets/ class=md-nav__link> <span class=md-ellipsis> A list of transforms and their supported targets </span> </a> </li> <li class=md-nav__item> <a href=../../getting_started/setting_probabilities/ class=md-nav__link> <span class=md-ellipsis> Setting probabilities for transforms </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Examples </span> </a> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class=md-nav__item> <a href=../../faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> External resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> External resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../external_resources/online_courses/ class=md-nav__link> <span class=md-ellipsis> Online classes that cover Albumentations </span> </a> </li> <li class=md-nav__item> <a href=../../external_resources/blog_posts_podcasts_talks/ class=md-nav__link> <span class=md-ellipsis> Blog posts, podcasts, talks, and videos about Albumentations </span> </a> </li> <li class=md-nav__item> <a href=../../external_resources/books/ class=md-nav__link> <span class=md-ellipsis> Books that mention Albumentations </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> Integrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../integrations/huggingface/ class=md-nav__link> <span class=md-ellipsis> HuggingFace </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../integrations/fiftyone/ class=md-nav__link> <span class=md-ellipsis> FiftyOne </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../train-rt-detr-on-custom-dataset-with-transformers class=md-nav__link> <span class=md-ellipsis> Roboflow </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../frameworks_and_libraries/ class=md-nav__link> <span class=md-ellipsis> Frameworks and libraries that use Albumentations </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_10> <div class="md-nav__link md-nav__container"> <a href=../../api_reference/ class="md-nav__link "> <span class=md-ellipsis> API Reference </span> </a> <label class="md-nav__link " for=__nav_10 id=__nav_10_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> API Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api_reference/full_reference/ class=md-nav__link> <span class=md-ellipsis> Full API Reference </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api_reference/core/ class=md-nav__link> <span class=md-ellipsis> Core API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api_reference/augmentations/ class=md-nav__link> <span class=md-ellipsis> Augmentations </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api_reference/pytorch/ class=md-nav__link> <span class=md-ellipsis> PyTorch Helpers </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_11> <div class="md-nav__link md-nav__container"> <a href=../../autoalbument/ class="md-nav__link "> <span class=md-ellipsis> AutoAlbument </span> </a> <label class="md-nav__link " for=__nav_11 id=__nav_11_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=false> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> AutoAlbument </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../autoalbument/benchmarks/ class=md-nav__link> <span class=md-ellipsis> Benchmarks and a comparison with baseline augmentation strategies </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/how_to_use/ class=md-nav__link> <span class=md-ellipsis> How to use AutoAlbument </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/docker/ class=md-nav__link> <span class=md-ellipsis> How to use an AutoAlbument Docker image </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/custom_model/ class=md-nav__link> <span class=md-ellipsis> How to use a custom classification or semantic segmentation model </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/metrics/ class=md-nav__link> <span class=md-ellipsis> Metrics and their meaning </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/tuning_parameters/ class=md-nav__link> <span class=md-ellipsis> Tuning the search parameters </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../autoalbument/examples/list/ class=md-nav__link> <span class=md-ellipsis> Examples </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/search_algorithms/ class=md-nav__link> <span class=md-ellipsis> Search algorithms </span> </a> </li> <li class=md-nav__item> <a href=../../autoalbument/faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../release_notes/ class=md-nav__link> <span class=md-ellipsis> Release notes </span> </a> </li> <li class=md-nav__item> <a href=../../CONTRIBUTING/ class=md-nav__link> <span class=md-ellipsis> Contributing to Albumentations </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <style>
  .highlight-ipynb {
    font-size: 0.7rem;
  }

  .jupyter-wrapper .jp-MarkdownOutput.jp-RenderedHTMLCommon {
    font-size: 0.8rem;
  }
</style> <a href=https://github.com/albumentations-team/albumentations.ai/tree/main/mkdocs/src/docs/examples/pytorch_semantic_segmentation.md title=edit.link.title class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg> </a> <h1 id=pytorch-and-albumentations-for-semantic-segmentation>PyTorch and Albumentations for semantic segmentation<a class=headerlink href=#pytorch-and-albumentations-for-semantic-segmentation title="Permanent link">&para;</a></h1> <p>This example shows how to use Albumentations for binary semantic segmentation. We will use the <a href=https://www.robots.ox.ac.uk/~vgg/data/pets/ >The Oxford-IIIT Pet Dataset </a>. The task will be to classify each pixel of an input image either as <code>pet</code> or <code>background</code>.</p> <h3 id=install-the-required-libraries>Install the required libraries<a class=headerlink href=#install-the-required-libraries title="Permanent link">&para;</a></h3> <p>We will use <a href=https://github.com/ternaus/TernausNet>TernausNet</a>, a library that provides pretrained <a href=https://en.wikipedia.org/wiki/U-Net>UNet</a> models for the semantic segmentation task.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos="1 "></span></a><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>ternausnet</span> <span class=o>&gt;</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>null</span>
</span></code></pre></div> <h3 id=import-the-required-libraries>Import the required libraries<a class=headerlink href=#import-the-required-libraries title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos=" 1 "></span></a><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos=" 2 "></span></a><span class=kn>import</span> <span class=nn>copy</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos=" 3 "></span></a><span class=kn>import</span> <span class=nn>random</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos=" 4 "></span></a><span class=kn>import</span> <span class=nn>os</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos=" 5 "></span></a><span class=kn>import</span> <span class=nn>shutil</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6></a><a href=#__codelineno-1-6><span class=linenos data-linenos=" 6 "></span></a><span class=kn>from</span> <span class=nn>urllib.request</span> <span class=kn>import</span> <span class=n>urlretrieve</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7></a><a href=#__codelineno-1-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8></a><a href=#__codelineno-1-8><span class=linenos data-linenos=" 8 "></span></a><span class=kn>import</span> <span class=nn>albumentations</span> <span class=k>as</span> <span class=nn>A</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9></a><a href=#__codelineno-1-9><span class=linenos data-linenos=" 9 "></span></a><span class=kn>import</span> <span class=nn>albumentations.augmentations.functional</span> <span class=k>as</span> <span class=nn>F</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10></a><a href=#__codelineno-1-10><span class=linenos data-linenos="10 "></span></a><span class=kn>from</span> <span class=nn>albumentations.pytorch</span> <span class=kn>import</span> <span class=n>ToTensorV2</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11></a><a href=#__codelineno-1-11><span class=linenos data-linenos="11 "></span></a><span class=kn>import</span> <span class=nn>cv2</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12></a><a href=#__codelineno-1-12><span class=linenos data-linenos="12 "></span></a><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13></a><a href=#__codelineno-1-13><span class=linenos data-linenos="13 "></span></a><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14></a><a href=#__codelineno-1-14><span class=linenos data-linenos="14 "></span></a><span class=kn>import</span> <span class=nn>ternausnet.models</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15></a><a href=#__codelineno-1-15><span class=linenos data-linenos="15 "></span></a><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16></a><a href=#__codelineno-1-16><span class=linenos data-linenos="16 "></span></a><span class=kn>import</span> <span class=nn>torch</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17></a><a href=#__codelineno-1-17><span class=linenos data-linenos="17 "></span></a><span class=kn>import</span> <span class=nn>torch.backends.cudnn</span> <span class=k>as</span> <span class=nn>cudnn</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18></a><a href=#__codelineno-1-18><span class=linenos data-linenos="18 "></span></a><span class=kn>import</span> <span class=nn>torch.nn</span> <span class=k>as</span> <span class=nn>nn</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19></a><a href=#__codelineno-1-19><span class=linenos data-linenos="19 "></span></a><span class=kn>import</span> <span class=nn>torch.optim</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20></a><a href=#__codelineno-1-20><span class=linenos data-linenos="20 "></span></a><span class=kn>from</span> <span class=nn>torch.utils.data</span> <span class=kn>import</span> <span class=n>Dataset</span><span class=p>,</span> <span class=n>DataLoader</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21></a><a href=#__codelineno-1-21><span class=linenos data-linenos="21 "></span></a>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22></a><a href=#__codelineno-1-22><span class=linenos data-linenos="22 "></span></a><span class=n>cudnn</span><span class=o>.</span><span class=n>benchmark</span> <span class=o>=</span> <span class=kc>True</span>
</span></code></pre></div> <h3 id=define-functions-to-download-an-archived-dataset-and-unpack-it>Define functions to download an archived dataset and unpack it<a class=headerlink href=#define-functions-to-download-an-archived-dataset-and-unpack-it title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span> <span class=nc>TqdmUpTo</span><span class=p>(</span><span class=n>tqdm</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span> <span class=nf>update_to</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>bsize</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>tsize</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=k>if</span> <span class=n>tsize</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>total</span> <span class=o>=</span> <span class=n>tsize</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>b</span> <span class=o>*</span> <span class=n>bsize</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a><span class=k>def</span> <span class=nf>download_url</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>filepath</span><span class=p>):</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>directory</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>filepath</span><span class=p>))</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>filepath</span><span class=p>):</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Dataset already exists on the disk. Skipping download.&quot;</span><span class=p>)</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a>        <span class=k>return</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>with</span> <span class=n>TqdmUpTo</span><span class=p>(</span><span class=n>unit</span><span class=o>=</span><span class=s2>&quot;B&quot;</span><span class=p>,</span> <span class=n>unit_scale</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>unit_divisor</span><span class=o>=</span><span class=mi>1024</span><span class=p>,</span> <span class=n>miniters</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>desc</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>filepath</span><span class=p>))</span> <span class=k>as</span> <span class=n>t</span><span class=p>:</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16></a><a href=#__codelineno-2-16><span class=linenos data-linenos="16 "></span></a>        <span class=n>urlretrieve</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=n>filepath</span><span class=p>,</span> <span class=n>reporthook</span><span class=o>=</span><span class=n>t</span><span class=o>.</span><span class=n>update_to</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17></a><a href=#__codelineno-2-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>t</span><span class=o>.</span><span class=n>total</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>n</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18></a><a href=#__codelineno-2-18><span class=linenos data-linenos="18 "></span></a>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19></a><a href=#__codelineno-2-19><span class=linenos data-linenos="19 "></span></a>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20></a><a href=#__codelineno-2-20><span class=linenos data-linenos="20 "></span></a><span class=k>def</span> <span class=nf>extract_archive</span><span class=p>(</span><span class=n>filepath</span><span class=p>):</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21></a><a href=#__codelineno-2-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>extract_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>filepath</span><span class=p>))</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22></a><a href=#__codelineno-2-22><span class=linenos data-linenos="22 "></span></a>    <span class=n>shutil</span><span class=o>.</span><span class=n>unpack_archive</span><span class=p>(</span><span class=n>filepath</span><span class=p>,</span> <span class=n>extract_dir</span><span class=p>)</span>
</span></code></pre></div> <h3 id=set-the-root-directory-for-the-downloaded-dataset>Set the root directory for the downloaded dataset<a class=headerlink href=#set-the-root-directory-for-the-downloaded-dataset title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos="1 "></span></a><span class=n>dataset_directory</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&quot;HOME&quot;</span><span class=p>],</span> <span class=s2>&quot;datasets/oxford-iiit-pet&quot;</span><span class=p>)</span>
</span></code></pre></div> <h3 id=download-and-extract-the-cats-vs-dogs-dataset>Download and extract the <code>Cats vs. Dogs</code> dataset<a class=headerlink href=#download-and-extract-the-cats-vs-dogs-dataset title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos="1 "></span></a><span class=n>filepath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dataset_directory</span><span class=p>,</span> <span class=s2>&quot;images.tar.gz&quot;</span><span class=p>)</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos="2 "></span></a><span class=n>download_url</span><span class=p>(</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>url</span><span class=o>=</span><span class=s2>&quot;https://www.robots.ox.ac.uk/~vgg/data/pets/data/images.tar.gz&quot;</span><span class=p>,</span> <span class=n>filepath</span><span class=o>=</span><span class=n>filepath</span><span class=p>,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos="4 "></span></a><span class=p>)</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos="5 "></span></a><span class=n>extract_archive</span><span class=p>(</span><span class=n>filepath</span><span class=p>)</span>
</span></code></pre></div> <div class=codehilite><pre><span></span><code><span class=n>Dataset</span><span class=w> </span><span class=n>already</span><span class=w> </span><span class=n>exists</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>disk</span><span class=o>.</span><span class=w> </span><span class=n>Skipping</span><span class=w> </span><span class=n>download</span><span class=o>.</span>
</code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos="1 "></span></a><span class=n>filepath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dataset_directory</span><span class=p>,</span> <span class=s2>&quot;annotations.tar.gz&quot;</span><span class=p>)</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos="2 "></span></a><span class=n>download_url</span><span class=p>(</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>url</span><span class=o>=</span><span class=s2>&quot;https://www.robots.ox.ac.uk/~vgg/data/pets/data/annotations.tar.gz&quot;</span><span class=p>,</span> <span class=n>filepath</span><span class=o>=</span><span class=n>filepath</span><span class=p>,</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos="4 "></span></a><span class=p>)</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos="5 "></span></a><span class=n>extract_archive</span><span class=p>(</span><span class=n>filepath</span><span class=p>)</span>
</span></code></pre></div> <div class=codehilite><pre><span></span><code><span class=n>Dataset</span><span class=w> </span><span class=n>already</span><span class=w> </span><span class=n>exists</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>disk</span><span class=o>.</span><span class=w> </span><span class=n>Skipping</span><span class=w> </span><span class=n>download</span><span class=o>.</span>
</code></pre></div> <h3 id=split-files-from-the-dataset-into-the-train-and-validation-sets>Split files from the dataset into the train and validation sets<a class=headerlink href=#split-files-from-the-dataset-into-the-train-and-validation-sets title="Permanent link">&para;</a></h3> <p>Some files in the dataset are broken, so we will use only those image files that OpenCV could load correctly. We will use 6000 images for training, 1374 images for validation, and 10 images for testing.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>root_directory</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dataset_directory</span><span class=p>)</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>images_directory</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root_directory</span><span class=p>,</span> <span class=s2>&quot;images&quot;</span><span class=p>)</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a><span class=n>masks_directory</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root_directory</span><span class=p>,</span> <span class=s2>&quot;annotations&quot;</span><span class=p>,</span> <span class=s2>&quot;trimaps&quot;</span><span class=p>)</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a><span class=n>images_filenames</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>sorted</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>images_directory</span><span class=p>)))</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>correct_images_filenames</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>images_filenames</span> <span class=k>if</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>images_directory</span><span class=p>,</span> <span class=n>i</span><span class=p>))</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>]</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>correct_images_filenames</span><span class=p>)</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a><span class=n>train_images_filenames</span> <span class=o>=</span> <span class=n>correct_images_filenames</span><span class=p>[:</span><span class=mi>6000</span><span class=p>]</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a><span class=n>val_images_filenames</span> <span class=o>=</span> <span class=n>correct_images_filenames</span><span class=p>[</span><span class=mi>6000</span><span class=p>:</span><span class=o>-</span><span class=mi>10</span><span class=p>]</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13></a><a href=#__codelineno-6-13><span class=linenos data-linenos="13 "></span></a><span class=n>test_images_filenames</span> <span class=o>=</span> <span class=n>images_filenames</span><span class=p>[</span><span class=o>-</span><span class=mi>10</span><span class=p>:]</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14></a><a href=#__codelineno-6-14><span class=linenos data-linenos="14 "></span></a>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15></a><a href=#__codelineno-6-15><span class=linenos data-linenos="15 "></span></a><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>train_images_filenames</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>val_images_filenames</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>))</span>
</span></code></pre></div> <div class=codehilite><pre><span></span><code><span class=mf>6000</span><span class=w> </span><span class=mf>1374</span><span class=w> </span><span class=mf>10</span>
</code></pre></div> <h3 id=define-a-function-to-preprocess-a-mask>Define a function to preprocess a mask<a class=headerlink href=#define-a-function-to-preprocess-a-mask title="Permanent link">&para;</a></h3> <p>The dataset contains pixel-level trimap segmentation. For each image, there is an associated PNG file with a mask. The size of a mask equals to the size of the related image. Each pixel in a mask image can take one of three values: <code>1</code>, <code>2</code>, or <code>3</code>. <code>1</code> means that this pixel of an image belongs to the class <code>pet</code>, <code>2</code> - to the class <code>background</code>, <code>3</code> - to the class <code>border</code>. Since this example demonstrates a task of binary segmentation (that is assigning one of two classes to each pixel), we will preprocess the mask, so it will contain only two uniques values: <code>0.0</code> if a pixel is a background and <code>1.0</code> if a pixel is a pet or a border.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos="1 "></span></a><span class=k>def</span> <span class=nf>preprocess_mask</span><span class=p>(</span><span class=n>mask</span><span class=p>):</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>mask</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>mask</span><span class=p>[</span><span class=n>mask</span> <span class=o>==</span> <span class=mf>2.0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>mask</span><span class=p>[(</span><span class=n>mask</span> <span class=o>==</span> <span class=mf>1.0</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>mask</span> <span class=o>==</span> <span class=mf>3.0</span><span class=p>)]</span> <span class=o>=</span> <span class=mf>1.0</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos="5 "></span></a>    <span class=k>return</span> <span class=n>mask</span>
</span></code></pre></div> <h3 id=define-a-function-to-visualize-images-and-their-labels>Define a function to visualize images and their labels<a class=headerlink href=#define-a-function-to-visualize-images-and-their-labels title="Permanent link">&para;</a></h3> <p>Let's define a visualization function that will take a list of images' file names, a path to the directory with images, a path to the directory with masks, and an optional argument with predicted masks (we will use this argument later to show predictions of a model).</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>display_image_grid</span><span class=p>(</span><span class=n>images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>predicted_masks</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>cols</span> <span class=o>=</span> <span class=mi>3</span> <span class=k>if</span> <span class=n>predicted_masks</span> <span class=k>else</span> <span class=mi>2</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>rows</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>images_filenames</span><span class=p>)</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>figure</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>nrows</span><span class=o>=</span><span class=n>rows</span><span class=p>,</span> <span class=n>ncols</span><span class=o>=</span><span class=n>cols</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>24</span><span class=p>))</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>image_filename</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>images_filenames</span><span class=p>):</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>images_directory</span><span class=p>,</span> <span class=n>image_filename</span><span class=p>))</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2RGB</span><span class=p>)</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>masks_directory</span><span class=p>,</span> <span class=n>image_filename</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;.jpg&quot;</span><span class=p>,</span> <span class=s2>&quot;.png&quot;</span><span class=p>)),</span> <span class=n>cv2</span><span class=o>.</span><span class=n>IMREAD_UNCHANGED</span><span class=p>,)</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>mask</span> <span class=o>=</span> <span class=n>preprocess_mask</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>interpolation</span><span class=o>=</span><span class=s2>&quot;nearest&quot;</span><span class=p>)</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Image&quot;</span><span class=p>)</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Ground truth mask&quot;</span><span class=p>)</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_axis_off</span><span class=p>()</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18></a><a href=#__codelineno-8-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_axis_off</span><span class=p>()</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19></a><a href=#__codelineno-8-19><span class=linenos data-linenos="19 "></span></a>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20></a><a href=#__codelineno-8-20><span class=linenos data-linenos="20 "></span></a>        <span class=k>if</span> <span class=n>predicted_masks</span><span class=p>:</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21></a><a href=#__codelineno-8-21><span class=linenos data-linenos="21 "></span></a>            <span class=n>predicted_mask</span> <span class=o>=</span> <span class=n>predicted_masks</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22></a><a href=#__codelineno-8-22><span class=linenos data-linenos="22 "></span></a>            <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>predicted_mask</span><span class=p>,</span> <span class=n>interpolation</span><span class=o>=</span><span class=s2>&quot;nearest&quot;</span><span class=p>)</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23></a><a href=#__codelineno-8-23><span class=linenos data-linenos="23 "></span></a>            <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Predicted mask&quot;</span><span class=p>)</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24></a><a href=#__codelineno-8-24><span class=linenos data-linenos="24 "></span></a>            <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_axis_off</span><span class=p>()</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25></a><a href=#__codelineno-8-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26></a><a href=#__codelineno-8-26><span class=linenos data-linenos="26 "></span></a>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a><span class=n>display_image_grid</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>)</span>
</span></code></pre></div> <p><img alt=png src=../pytorch_semantic_segmentation_files/pytorch_semantic_segmentation_23_0.png></p> <h3 id=image-sizes-for-training-and-prediction>Image sizes for training and prediction<a class=headerlink href=#image-sizes-for-training-and-prediction title="Permanent link">&para;</a></h3> <p>Often, images that you use for training and inference have different heights and widths and different aspect ratios. That fact brings two challenges to a deep learning pipeline: - PyTorch requires all images in a batch to have the same height and width. - If a neural network is not fully convolutional, you have to use the same width and height for all images during training and inference. Fully convolutional architectures, such as UNet, can work with images of any size.</p> <p>There are three common ways to deal with those challenges: 1. Resize all images and masks to a fixed size (e.g., 256x256 pixels) during training. After a model predicts a mask with that fixed size during inference, resize the mask to the original image size. This approach is simple, but it has a few drawbacks: - The predicted mask is smaller than the image, and the mask may lose some context and important details of the original image. - This approach may be problematic if images in your dataset have different aspect ratios. For example, suppose you are resizing an image with the size 1024x512 pixels (so an image with an aspect ratio of 2:1) to 256x256 pixels (1:1 aspect ratio). In that case, this transformation will distort the image and may also affect the quality of predictions. 2. If you use a fully convolutional neural network, you can train a model with image crops, but use original images for inference. This option usually provides the best tradeoff between quality, speed of training, and hardware requirements. 3. Do not alter the sizes of images and use source images both for training and inference. With this approach, you won't lose any information. However, original images could be quite large, so they may require a lot of GPU memory. Also, this approach requires more training time to obtain good results.</p> <p>Some architectures, such as UNet, require that an image's size must be divisible by a downsampling factor of a network (usually 32), so you may also need to pad an image with borders. Albumentations provides a particular transformation for that case.</p> <p>The following example shows how different types of images look.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a><span class=n>example_image_filename</span> <span class=o>=</span> <span class=n>correct_images_filenames</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos="2 "></span></a><span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>images_directory</span><span class=p>,</span> <span class=n>example_image_filename</span><span class=p>))</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos="3 "></span></a><span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2RGB</span><span class=p>)</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos="4 "></span></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos="5 "></span></a><span class=n>resized_image</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>height</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=mi>256</span><span class=p>)</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6></a><a href=#__codelineno-10-6><span class=linenos data-linenos="6 "></span></a><span class=n>padded_image</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>pad</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>min_height</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>512</span><span class=p>)</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7></a><a href=#__codelineno-10-7><span class=linenos data-linenos="7 "></span></a><span class=n>padded_constant_image</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>pad</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>min_height</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>border_mode</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>BORDER_CONSTANT</span><span class=p>)</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8></a><a href=#__codelineno-10-8><span class=linenos data-linenos="8 "></span></a><span class=n>cropped_image</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>center_crop</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>crop_height</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>crop_width</span><span class=o>=</span><span class=mi>256</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>figure</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>nrows</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>ncols</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>18</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><a href=#__codelineno-11-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a><a href=#__codelineno-11-3><span class=linenos data-linenos=" 3 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Original image&quot;</span><span class=p>)</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><a href=#__codelineno-11-4><span class=linenos data-linenos=" 4 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>resized_image</span><span class=p>)</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><a href=#__codelineno-11-5><span class=linenos data-linenos=" 5 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Resized image&quot;</span><span class=p>)</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a><a href=#__codelineno-11-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>cropped_image</span><span class=p>)</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a><a href=#__codelineno-11-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Cropped image&quot;</span><span class=p>)</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a><a href=#__codelineno-11-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>padded_image</span><span class=p>)</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a><a href=#__codelineno-11-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Image padded with reflection&quot;</span><span class=p>)</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a><a href=#__codelineno-11-10><span class=linenos data-linenos="10 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>4</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>padded_constant_image</span><span class=p>)</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11></a><a href=#__codelineno-11-11><span class=linenos data-linenos="11 "></span></a><span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()[</span><span class=mi>4</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Image padded with constant padding&quot;</span><span class=p>)</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12></a><a href=#__codelineno-11-12><span class=linenos data-linenos="12 "></span></a><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13></a><a href=#__codelineno-11-13><span class=linenos data-linenos="13 "></span></a><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt=png src=../pytorch_semantic_segmentation_files/pytorch_semantic_segmentation_28_0.png></p> <p>In this tutorial, we will explore all three approaches for dealing with image sizes.</p> <h2 id=approach-1-resize-all-images-and-masks-to-a-fixed-size-eg-256x256-pixels>Approach 1. Resize all images and masks to a fixed size (e.g., 256x256 pixels).<a class=headerlink href=#approach-1-resize-all-images-and-masks-to-a-fixed-size-eg-256x256-pixels title="Permanent link">&para;</a></h2> <h3 id=define-a-pytorch-dataset-class>Define a PyTorch dataset class<a class=headerlink href=#define-a-pytorch-dataset-class title="Permanent link">&para;</a></h3> <p>Next, we define a PyTorch dataset. If you are new to PyTorch datasets, please refer to this tutorial - <a href=https://pytorch.org/tutorials/beginner/data_loading_tutorial.html>https://pytorch.org/tutorials/beginner/data_loading_tutorial.html</a>.</p> <p><code>__init__</code> will receive an optional <code>transform</code> argument. It is a transformation function of the Albumentations augmentation pipeline. Then in <code>__getitem__</code>, the Dataset class will use that function to augment an image and a mask and return their augmented versions.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span> <span class=nc>OxfordPetDataset</span><span class=p>(</span><span class=n>Dataset</span><span class=p>):</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>images_filenames</span> <span class=o>=</span> <span class=n>images_filenames</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>images_directory</span> <span class=o>=</span> <span class=n>images_directory</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><a href=#__codelineno-12-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>masks_directory</span> <span class=o>=</span> <span class=n>masks_directory</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a><a href=#__codelineno-12-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=o>=</span> <span class=n>transform</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a><a href=#__codelineno-12-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a><a href=#__codelineno-12-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a><a href=#__codelineno-12-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>images_filenames</span><span class=p>)</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a><a href=#__codelineno-12-10><span class=linenos data-linenos="10 "></span></a>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a><a href=#__codelineno-12-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><a href=#__codelineno-12-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>image_filename</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>images_filenames</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a><a href=#__codelineno-12-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>images_directory</span><span class=p>,</span> <span class=n>image_filename</span><span class=p>))</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><a href=#__codelineno-12-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2RGB</span><span class=p>)</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a><a href=#__codelineno-12-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a><a href=#__codelineno-12-16><span class=linenos data-linenos="16 "></span></a>            <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>masks_directory</span><span class=p>,</span> <span class=n>image_filename</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;.jpg&quot;</span><span class=p>,</span> <span class=s2>&quot;.png&quot;</span><span class=p>)),</span> <span class=n>cv2</span><span class=o>.</span><span class=n>IMREAD_UNCHANGED</span><span class=p>,</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a><a href=#__codelineno-12-17><span class=linenos data-linenos="17 "></span></a>        <span class=p>)</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a><a href=#__codelineno-12-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>mask</span> <span class=o>=</span> <span class=n>preprocess_mask</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a><a href=#__codelineno-12-19><span class=linenos data-linenos="19 "></span></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20></a><a href=#__codelineno-12-20><span class=linenos data-linenos="20 "></span></a>            <span class=n>transformed</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=n>image</span><span class=o>=</span><span class=n>image</span><span class=p>,</span> <span class=n>mask</span><span class=o>=</span><span class=n>mask</span><span class=p>)</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21></a><a href=#__codelineno-12-21><span class=linenos data-linenos="21 "></span></a>            <span class=n>image</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>[</span><span class=s2>&quot;image&quot;</span><span class=p>]</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22></a><a href=#__codelineno-12-22><span class=linenos data-linenos="22 "></span></a>            <span class=n>mask</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>[</span><span class=s2>&quot;mask&quot;</span><span class=p>]</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23></a><a href=#__codelineno-12-23><span class=linenos data-linenos="23 "></span></a>        <span class=k>return</span> <span class=n>image</span><span class=p>,</span> <span class=n>mask</span>
</span></code></pre></div> <p>Next, we create augmentation pipelines for the training and validation datasets. Note that we use <code>A.Resize(256, 256)</code> to resize input images and masks to the size 256x256 pixels.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>train_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=p>[</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Resize</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>),</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>ShiftScaleRotate</span><span class=p>(</span><span class=n>shift_limit</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>scale_limit</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>rotate_limit</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RGBShift</span><span class=p>(</span><span class=n>r_shift_limit</span><span class=o>=</span><span class=mi>25</span><span class=p>,</span> <span class=n>g_shift_limit</span><span class=o>=</span><span class=mi>25</span><span class=p>,</span> <span class=n>b_shift_limit</span><span class=o>=</span><span class=mi>25</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RandomBrightnessContrast</span><span class=p>(</span><span class=n>brightness_limit</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>contrast_limit</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>]</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a><span class=p>)</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a><span class=n>train_dataset</span> <span class=o>=</span> <span class=n>OxfordPetDataset</span><span class=p>(</span><span class=n>train_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>train_transform</span><span class=p>,)</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12></a><a href=#__codelineno-13-12><span class=linenos data-linenos="12 "></span></a>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13></a><a href=#__codelineno-13-13><span class=linenos data-linenos="13 "></span></a><span class=n>val_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14></a><a href=#__codelineno-13-14><span class=linenos data-linenos="14 "></span></a>    <span class=p>[</span><span class=n>A</span><span class=o>.</span><span class=n>Resize</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>),</span> <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span> <span class=n>ToTensorV2</span><span class=p>()]</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15></a><a href=#__codelineno-13-15><span class=linenos data-linenos="15 "></span></a><span class=p>)</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16></a><a href=#__codelineno-13-16><span class=linenos data-linenos="16 "></span></a><span class=n>val_dataset</span> <span class=o>=</span> <span class=n>OxfordPetDataset</span><span class=p>(</span><span class=n>val_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>val_transform</span><span class=p>,)</span>
</span></code></pre></div> <p>Let's define a function that takes a dataset and visualizes different augmentations applied to the same image and the associated mask.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>visualize_augmentations</span><span class=p>(</span><span class=n>dataset</span><span class=p>,</span> <span class=n>idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>samples</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>dataset</span><span class=o>.</span><span class=n>transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>([</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>dataset</span><span class=o>.</span><span class=n>transform</span> <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=p>(</span><span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>,</span> <span class=n>ToTensorV2</span><span class=p>))])</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>figure</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>nrows</span><span class=o>=</span><span class=n>samples</span><span class=p>,</span> <span class=n>ncols</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>24</span><span class=p>))</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>samples</span><span class=p>):</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>image</span><span class=p>,</span> <span class=n>mask</span> <span class=o>=</span> <span class=n>dataset</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>interpolation</span><span class=o>=</span><span class=s2>&quot;nearest&quot;</span><span class=p>)</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Augmented image&quot;</span><span class=p>)</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Augmented mask&quot;</span><span class=p>)</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_axis_off</span><span class=p>()</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_axis_off</span><span class=p>()</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a><a href=#__codelineno-14-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a><a href=#__codelineno-14-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos="1 "></span></a><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos="2 "></span></a><span class=n>visualize_augmentations</span><span class=p>(</span><span class=n>train_dataset</span><span class=p>,</span> <span class=n>idx</span><span class=o>=</span><span class=mi>55</span><span class=p>)</span>
</span></code></pre></div> <p><img alt=png src=../pytorch_semantic_segmentation_files/pytorch_semantic_segmentation_38_0.png></p> <h3 id=define-helpers-for-training>Define helpers for training<a class=headerlink href=#define-helpers-for-training title="Permanent link">&para;</a></h3> <p><code>MetricMonitor</code> helps to track metrics such as accuracy or loss during training and validation.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span> <span class=nc>MetricMonitor</span><span class=p>:</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>float_precision</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>float_precision</span> <span class=o>=</span> <span class=n>float_precision</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>reset</span><span class=p>()</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos=" 5 "></span></a>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>def</span> <span class=nf>reset</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;val&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&quot;count&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&quot;avg&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metric_name</span><span class=p>,</span> <span class=n>val</span><span class=p>):</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10></a><a href=#__codelineno-16-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>metric</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=n>metric_name</span><span class=p>]</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11></a><a href=#__codelineno-16-11><span class=linenos data-linenos="11 "></span></a>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12></a><a href=#__codelineno-16-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>metric</span><span class=p>[</span><span class=s2>&quot;val&quot;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>val</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13></a><a href=#__codelineno-16-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>metric</span><span class=p>[</span><span class=s2>&quot;count&quot;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14></a><a href=#__codelineno-16-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>metric</span><span class=p>[</span><span class=s2>&quot;avg&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>metric</span><span class=p>[</span><span class=s2>&quot;val&quot;</span><span class=p>]</span> <span class=o>/</span> <span class=n>metric</span><span class=p>[</span><span class=s2>&quot;count&quot;</span><span class=p>]</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15></a><a href=#__codelineno-16-15><span class=linenos data-linenos="15 "></span></a>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16></a><a href=#__codelineno-16-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17></a><a href=#__codelineno-16-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>return</span> <span class=s2>&quot; | &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18></a><a href=#__codelineno-16-18><span class=linenos data-linenos="18 "></span></a>            <span class=p>[</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19></a><a href=#__codelineno-16-19><span class=linenos data-linenos="19 "></span></a>                <span class=s2>&quot;</span><span class=si>{metric_name}</span><span class=s2>: {avg:.</span><span class=si>{float_precision}</span><span class=s2>f}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20></a><a href=#__codelineno-16-20><span class=linenos data-linenos="20 "></span></a>                    <span class=n>metric_name</span><span class=o>=</span><span class=n>metric_name</span><span class=p>,</span> <span class=n>avg</span><span class=o>=</span><span class=n>metric</span><span class=p>[</span><span class=s2>&quot;avg&quot;</span><span class=p>],</span> <span class=n>float_precision</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>float_precision</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21></a><a href=#__codelineno-16-21><span class=linenos data-linenos="21 "></span></a>                <span class=p>)</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22></a><a href=#__codelineno-16-22><span class=linenos data-linenos="22 "></span></a>                <span class=k>for</span> <span class=p>(</span><span class=n>metric_name</span><span class=p>,</span> <span class=n>metric</span><span class=p>)</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23></a><a href=#__codelineno-16-23><span class=linenos data-linenos="23 "></span></a>            <span class=p>]</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24></a><a href=#__codelineno-16-24><span class=linenos data-linenos="24 "></span></a>        <span class=p>)</span>
</span></code></pre></div> <h3 id=define-functions-for-training-and-validation>Define functions for training and validation<a class=headerlink href=#define-functions-for-training-and-validation title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>train</span><span class=p>(</span><span class=n>train_loader</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>criterion</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>epoch</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>metric_monitor</span> <span class=o>=</span> <span class=n>MetricMonitor</span><span class=p>()</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>stream</span> <span class=o>=</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>train_loader</span><span class=p>)</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>images</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>images</span> <span class=o>=</span> <span class=n>images</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>],</span> <span class=n>non_blocking</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7></a><a href=#__codelineno-17-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>target</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>],</span> <span class=n>non_blocking</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8></a><a href=#__codelineno-17-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>images</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9></a><a href=#__codelineno-17-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10></a><a href=#__codelineno-17-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>metric_monitor</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=s2>&quot;Loss&quot;</span><span class=p>,</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11></a><a href=#__codelineno-17-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12></a><a href=#__codelineno-17-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13></a><a href=#__codelineno-17-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14></a><a href=#__codelineno-17-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>stream</span><span class=o>.</span><span class=n>set_description</span><span class=p>(</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15></a><a href=#__codelineno-17-15><span class=linenos data-linenos="15 "></span></a>            <span class=s2>&quot;Epoch: </span><span class=si>{epoch}</span><span class=s2>. Train.      </span><span class=si>{metric_monitor}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>epoch</span><span class=o>=</span><span class=n>epoch</span><span class=p>,</span> <span class=n>metric_monitor</span><span class=o>=</span><span class=n>metric_monitor</span><span class=p>)</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16></a><a href=#__codelineno-17-16><span class=linenos data-linenos="16 "></span></a>        <span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>validate</span><span class=p>(</span><span class=n>val_loader</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>criterion</span><span class=p>,</span> <span class=n>epoch</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>metric_monitor</span> <span class=o>=</span> <span class=n>MetricMonitor</span><span class=p>()</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><a href=#__codelineno-18-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>stream</span> <span class=o>=</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>val_loader</span><span class=p>)</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a><a href=#__codelineno-18-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><a href=#__codelineno-18-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>images</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a><a href=#__codelineno-18-7><span class=linenos data-linenos=" 7 "></span></a>            <span class=n>images</span> <span class=o>=</span> <span class=n>images</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>],</span> <span class=n>non_blocking</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a><a href=#__codelineno-18-8><span class=linenos data-linenos=" 8 "></span></a>            <span class=n>target</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>],</span> <span class=n>non_blocking</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a><a href=#__codelineno-18-9><span class=linenos data-linenos=" 9 "></span></a>            <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>images</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a><a href=#__codelineno-18-10><span class=linenos data-linenos="10 "></span></a>            <span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11></a><a href=#__codelineno-18-11><span class=linenos data-linenos="11 "></span></a>            <span class=n>metric_monitor</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=s2>&quot;Loss&quot;</span><span class=p>,</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12></a><a href=#__codelineno-18-12><span class=linenos data-linenos="12 "></span></a>            <span class=n>stream</span><span class=o>.</span><span class=n>set_description</span><span class=p>(</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13></a><a href=#__codelineno-18-13><span class=linenos data-linenos="13 "></span></a>                <span class=s2>&quot;Epoch: </span><span class=si>{epoch}</span><span class=s2>. Validation. </span><span class=si>{metric_monitor}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>epoch</span><span class=o>=</span><span class=n>epoch</span><span class=p>,</span> <span class=n>metric_monitor</span><span class=o>=</span><span class=n>metric_monitor</span><span class=p>)</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14></a><a href=#__codelineno-18-14><span class=linenos data-linenos="14 "></span></a>            <span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos="1 "></span></a><span class=k>def</span> <span class=nf>create_model</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>model</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>ternausnet</span><span class=o>.</span><span class=n>models</span><span class=p>,</span> <span class=n>params</span><span class=p>[</span><span class=s2>&quot;model&quot;</span><span class=p>])(</span><span class=n>pretrained</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>])</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos="4 "></span></a>    <span class=k>return</span> <span class=n>model</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>train_and_validate</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>train_dataset</span><span class=p>,</span> <span class=n>val_dataset</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>train_loader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>train_dataset</span><span class=p>,</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=n>batch_size</span><span class=o>=</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;batch_size&quot;</span><span class=p>],</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6></a><a href=#__codelineno-20-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>num_workers</span><span class=o>=</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;num_workers&quot;</span><span class=p>],</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7></a><a href=#__codelineno-20-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>pin_memory</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8></a><a href=#__codelineno-20-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=p>)</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9></a><a href=#__codelineno-20-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>val_loader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10></a><a href=#__codelineno-20-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>val_dataset</span><span class=p>,</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11></a><a href=#__codelineno-20-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>batch_size</span><span class=o>=</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;batch_size&quot;</span><span class=p>],</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12></a><a href=#__codelineno-20-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>shuffle</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13></a><a href=#__codelineno-20-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>num_workers</span><span class=o>=</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;num_workers&quot;</span><span class=p>],</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14></a><a href=#__codelineno-20-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>pin_memory</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15></a><a href=#__codelineno-20-15><span class=linenos data-linenos="15 "></span></a>    <span class=p>)</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16></a><a href=#__codelineno-20-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>criterion</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>BCEWithLogitsLoss</span><span class=p>()</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>])</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17></a><a href=#__codelineno-20-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>optimizer</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>optim</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>(),</span> <span class=n>lr</span><span class=o>=</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;lr&quot;</span><span class=p>])</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18></a><a href=#__codelineno-20-18><span class=linenos data-linenos="18 "></span></a>    <span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>params</span><span class=p>[</span><span class=s2>&quot;epochs&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19></a><a href=#__codelineno-20-19><span class=linenos data-linenos="19 "></span></a>        <span class=n>train</span><span class=p>(</span><span class=n>train_loader</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>criterion</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>epoch</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20></a><a href=#__codelineno-20-20><span class=linenos data-linenos="20 "></span></a>        <span class=n>validate</span><span class=p>(</span><span class=n>val_loader</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>criterion</span><span class=p>,</span> <span class=n>epoch</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21></a><a href=#__codelineno-20-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>return</span> <span class=n>model</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>test_dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>):</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2></a><a href=#__codelineno-21-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>test_loader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3></a><a href=#__codelineno-21-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>test_dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>shuffle</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>num_workers</span><span class=o>=</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;num_workers&quot;</span><span class=p>],</span> <span class=n>pin_memory</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4></a><a href=#__codelineno-21-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=p>)</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5></a><a href=#__codelineno-21-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6></a><a href=#__codelineno-21-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>predictions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7></a><a href=#__codelineno-21-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8></a><a href=#__codelineno-21-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=k>for</span> <span class=n>images</span><span class=p>,</span> <span class=p>(</span><span class=n>original_heights</span><span class=p>,</span> <span class=n>original_widths</span><span class=p>)</span> <span class=ow>in</span> <span class=n>test_loader</span><span class=p>:</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9></a><a href=#__codelineno-21-9><span class=linenos data-linenos=" 9 "></span></a>            <span class=n>images</span> <span class=o>=</span> <span class=n>images</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s2>&quot;device&quot;</span><span class=p>],</span> <span class=n>non_blocking</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10></a><a href=#__codelineno-21-10><span class=linenos data-linenos="10 "></span></a>            <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>images</span><span class=p>)</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11></a><a href=#__codelineno-21-11><span class=linenos data-linenos="11 "></span></a>            <span class=n>probabilities</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>sigmoid</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12></a><a href=#__codelineno-21-12><span class=linenos data-linenos="12 "></span></a>            <span class=n>predicted_masks</span> <span class=o>=</span> <span class=p>(</span><span class=n>probabilities</span> <span class=o>&gt;=</span> <span class=mf>0.5</span><span class=p>)</span><span class=o>.</span><span class=n>float</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13></a><a href=#__codelineno-21-13><span class=linenos data-linenos="13 "></span></a>            <span class=n>predicted_masks</span> <span class=o>=</span> <span class=n>predicted_masks</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14></a><a href=#__codelineno-21-14><span class=linenos data-linenos="14 "></span></a>            <span class=k>for</span> <span class=n>predicted_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15></a><a href=#__codelineno-21-15><span class=linenos data-linenos="15 "></span></a>                <span class=n>predicted_masks</span><span class=p>,</span> <span class=n>original_heights</span><span class=o>.</span><span class=n>numpy</span><span class=p>(),</span> <span class=n>original_widths</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16></a><a href=#__codelineno-21-16><span class=linenos data-linenos="16 "></span></a>            <span class=p>):</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17></a><a href=#__codelineno-21-17><span class=linenos data-linenos="17 "></span></a>                <span class=n>predictions</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>predicted_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span><span class=p>))</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18></a><a href=#__codelineno-21-18><span class=linenos data-linenos="18 "></span></a>    <span class=k>return</span> <span class=n>predictions</span>
</span></code></pre></div> <h3 id=define-training-parameters>Define training parameters<a class=headerlink href=#define-training-parameters title="Permanent link">&para;</a></h3> <p>Here we define a few training parameters such as model architecture, learning rate, batch size, epochs, etc.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos="1 "></span></a><span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos="2 "></span></a>    <span class=s2>&quot;model&quot;</span><span class=p>:</span> <span class=s2>&quot;UNet11&quot;</span><span class=p>,</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos="3 "></span></a>    <span class=s2>&quot;device&quot;</span><span class=p>:</span> <span class=s2>&quot;cuda&quot;</span><span class=p>,</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4></a><a href=#__codelineno-22-4><span class=linenos data-linenos="4 "></span></a>    <span class=s2>&quot;lr&quot;</span><span class=p>:</span> <span class=mf>0.001</span><span class=p>,</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5></a><a href=#__codelineno-22-5><span class=linenos data-linenos="5 "></span></a>    <span class=s2>&quot;batch_size&quot;</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6></a><a href=#__codelineno-22-6><span class=linenos data-linenos="6 "></span></a>    <span class=s2>&quot;num_workers&quot;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7></a><a href=#__codelineno-22-7><span class=linenos data-linenos="7 "></span></a>    <span class=s2>&quot;epochs&quot;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8></a><a href=#__codelineno-22-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>
</span></code></pre></div> <h3 id=train-a-model>Train a model<a class=headerlink href=#train-a-model title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos="1 "></span></a><span class=n>model</span> <span class=o>=</span> <span class=n>create_model</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos="2 "></span></a><span class=n>model</span> <span class=o>=</span> <span class=n>train_and_validate</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>train_dataset</span><span class=p>,</span> <span class=n>val_dataset</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></code></pre></div> <div class=codehilite><pre><span></span><code><span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.415</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:42&lt;00:00,  3.66it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.210</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:09&lt;00:00,  9.55it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>2</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.257</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>2</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.178</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.62it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.221</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.168</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.58it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.209</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.156</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.57it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>5</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.190</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>5</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.149</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.57it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>6</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.179</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>6</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.155</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.55it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.175</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.147</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.59it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.167</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.146</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.61it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>9</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.165</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>9</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.131</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.56it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>10</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.156</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>10</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.140</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.60it/s</span><span class=o>]</span>
</code></pre></div> <h3 id=predict-labels-for-images-and-visualize-those-predictions>Predict labels for images and visualize those predictions<a class=headerlink href=#predict-labels-for-images-and-visualize-those-predictions title="Permanent link">&para;</a></h3> <p>Now we have a trained model, so let's try to predict masks for some images. Note that the <code>__getitem__</code> method returns not only an image but also the original height and width of an image. We will use those values to resize a predicted mask from the size of 256x256 pixels to the original image's size.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span> <span class=nc>OxfordPetInferenceDataset</span><span class=p>(</span><span class=n>Dataset</span><span class=p>):</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>images_filenames</span> <span class=o>=</span> <span class=n>images_filenames</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>images_directory</span> <span class=o>=</span> <span class=n>images_directory</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5></a><a href=#__codelineno-24-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=o>=</span> <span class=n>transform</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6></a><a href=#__codelineno-24-6><span class=linenos data-linenos=" 6 "></span></a>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7></a><a href=#__codelineno-24-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8></a><a href=#__codelineno-24-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>images_filenames</span><span class=p>)</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9></a><a href=#__codelineno-24-9><span class=linenos data-linenos=" 9 "></span></a>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10></a><a href=#__codelineno-24-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11></a><a href=#__codelineno-24-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>image_filename</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>images_filenames</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12></a><a href=#__codelineno-24-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>images_directory</span><span class=p>,</span> <span class=n>image_filename</span><span class=p>))</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13></a><a href=#__codelineno-24-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2RGB</span><span class=p>)</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14></a><a href=#__codelineno-24-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>original_size</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>image</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>])</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15></a><a href=#__codelineno-24-15><span class=linenos data-linenos="15 "></span></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16></a><a href=#__codelineno-24-16><span class=linenos data-linenos="16 "></span></a>            <span class=n>transformed</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=n>image</span><span class=o>=</span><span class=n>image</span><span class=p>)</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17></a><a href=#__codelineno-24-17><span class=linenos data-linenos="17 "></span></a>            <span class=n>image</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>[</span><span class=s2>&quot;image&quot;</span><span class=p>]</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18></a><a href=#__codelineno-24-18><span class=linenos data-linenos="18 "></span></a>        <span class=k>return</span> <span class=n>image</span><span class=p>,</span> <span class=n>original_size</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos="1 "></span></a><span class=n>test_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a><a href=#__codelineno-25-2><span class=linenos data-linenos="2 "></span></a>    <span class=p>[</span><span class=n>A</span><span class=o>.</span><span class=n>Resize</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>),</span> <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span> <span class=n>ToTensorV2</span><span class=p>()]</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a><a href=#__codelineno-25-3><span class=linenos data-linenos="3 "></span></a><span class=p>)</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a><a href=#__codelineno-25-4><span class=linenos data-linenos="4 "></span></a><span class=n>test_dataset</span> <span class=o>=</span> <span class=n>OxfordPetInferenceDataset</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>test_transform</span><span class=p>,)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos="1 "></span></a><span class=n>predictions</span> <span class=o>=</span> <span class=n>predict</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>test_dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></code></pre></div> <p>Next, we will resize the predicted masks with the size of 256x256 pixels to the original images' size.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos="1 "></span></a><span class=n>predicted_masks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos="2 "></span></a><span class=k>for</span> <span class=n>predicted_256x256_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span> <span class=ow>in</span> <span class=n>predictions</span><span class=p>:</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>full_sized_mask</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>predicted_256x256_mask</span><span class=p>,</span> <span class=n>height</span><span class=o>=</span><span class=n>original_height</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=n>original_width</span><span class=p>,</span> <span class=n>interpolation</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>INTER_NEAREST</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5></a><a href=#__codelineno-27-5><span class=linenos data-linenos="5 "></span></a>    <span class=p>)</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6></a><a href=#__codelineno-27-6><span class=linenos data-linenos="6 "></span></a>    <span class=n>predicted_masks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>full_sized_mask</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos="1 "></span></a><span class=n>display_image_grid</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>predicted_masks</span><span class=o>=</span><span class=n>predicted_masks</span><span class=p>)</span>
</span></code></pre></div> <p><img alt=png src=../pytorch_semantic_segmentation_files/pytorch_semantic_segmentation_60_0.png></p> <h2 id=approach-2-train-on-crops-predict-masks-for-full-sized-images>Approach 2. Train on crops, predict masks for full-sized images<a class=headerlink href=#approach-2-train-on-crops-predict-masks-for-full-sized-images title="Permanent link">&para;</a></h2> <p>We will reuse most of the code from the previous example.</p> <p>Heights and widths of the same images in the dataset are less than the crop size (256x256 pixels), so we first apply <code>A.PadIfNeeded(min_height=256, min_width=256)</code> which will pad an image if its height or width is less than 256 pixels.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>train_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=p>[</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>PadIfNeeded</span><span class=p>(</span><span class=n>min_height</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>256</span><span class=p>),</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4></a><a href=#__codelineno-29-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RandomCrop</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>),</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5></a><a href=#__codelineno-29-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>ShiftScaleRotate</span><span class=p>(</span><span class=n>shift_limit</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>scale_limit</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>rotate_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6></a><a href=#__codelineno-29-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RGBShift</span><span class=p>(</span><span class=n>r_shift_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>g_shift_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>b_shift_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7></a><a href=#__codelineno-29-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RandomBrightnessContrast</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8></a><a href=#__codelineno-29-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9></a><a href=#__codelineno-29-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10></a><a href=#__codelineno-29-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>]</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11></a><a href=#__codelineno-29-11><span class=linenos data-linenos="11 "></span></a><span class=p>)</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12></a><a href=#__codelineno-29-12><span class=linenos data-linenos="12 "></span></a><span class=n>train_dataset</span> <span class=o>=</span> <span class=n>OxfordPetDataset</span><span class=p>(</span><span class=n>train_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>train_transform</span><span class=p>,)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1></a><a href=#__codelineno-30-1><span class=linenos data-linenos="1 "></span></a><span class=n>val_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2></a><a href=#__codelineno-30-2><span class=linenos data-linenos="2 "></span></a>    <span class=p>[</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3></a><a href=#__codelineno-30-3><span class=linenos data-linenos="3 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>PadIfNeeded</span><span class=p>(</span><span class=n>min_height</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>256</span><span class=p>),</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4></a><a href=#__codelineno-30-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>CenterCrop</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>),</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5></a><a href=#__codelineno-30-5><span class=linenos data-linenos="5 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6></a><a href=#__codelineno-30-6><span class=linenos data-linenos="6 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7></a><a href=#__codelineno-30-7><span class=linenos data-linenos="7 "></span></a>    <span class=p>]</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8></a><a href=#__codelineno-30-8><span class=linenos data-linenos="8 "></span></a><span class=p>)</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9></a><a href=#__codelineno-30-9><span class=linenos data-linenos="9 "></span></a><span class=n>val_dataset</span> <span class=o>=</span> <span class=n>OxfordPetDataset</span><span class=p>(</span><span class=n>val_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>val_transform</span><span class=p>,)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1></a><a href=#__codelineno-31-1><span class=linenos data-linenos="1 "></span></a><span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2></a><a href=#__codelineno-31-2><span class=linenos data-linenos="2 "></span></a>    <span class=s2>&quot;model&quot;</span><span class=p>:</span> <span class=s2>&quot;UNet11&quot;</span><span class=p>,</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3></a><a href=#__codelineno-31-3><span class=linenos data-linenos="3 "></span></a>    <span class=s2>&quot;device&quot;</span><span class=p>:</span> <span class=s2>&quot;cuda&quot;</span><span class=p>,</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4></a><a href=#__codelineno-31-4><span class=linenos data-linenos="4 "></span></a>    <span class=s2>&quot;lr&quot;</span><span class=p>:</span> <span class=mf>0.001</span><span class=p>,</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5></a><a href=#__codelineno-31-5><span class=linenos data-linenos="5 "></span></a>    <span class=s2>&quot;batch_size&quot;</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6></a><a href=#__codelineno-31-6><span class=linenos data-linenos="6 "></span></a>    <span class=s2>&quot;num_workers&quot;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7></a><a href=#__codelineno-31-7><span class=linenos data-linenos="7 "></span></a>    <span class=s2>&quot;epochs&quot;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8></a><a href=#__codelineno-31-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1></a><a href=#__codelineno-32-1><span class=linenos data-linenos="1 "></span></a><span class=n>model</span> <span class=o>=</span> <span class=n>create_model</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2></a><a href=#__codelineno-32-2><span class=linenos data-linenos="2 "></span></a><span class=n>model</span> <span class=o>=</span> <span class=n>train_and_validate</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>train_dataset</span><span class=p>,</span> <span class=n>val_dataset</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></code></pre></div> <div class=codehilite><pre><span></span><code><span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.445</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.279</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.49it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>2</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.311</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>2</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.238</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.51it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.259</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.206</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.54it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.244</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.211</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.54it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>5</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.224</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.74it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>5</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.270</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.47it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>6</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.207</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>6</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.169</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.56it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.212</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.169</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.56it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.189</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:40&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.201</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.52it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>9</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.185</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>9</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.162</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.54it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>10</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.187</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>375</span><span class=sr>/375 [01:39&lt;00:00,  3.75it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>10</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.159</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>86</span><span class=sr>/86 [00:08&lt;00:00, 10.49it/s</span><span class=o>]</span>
</code></pre></div> <p>All images in the test dataset have a max side with size 500 pixels. Since PyTorch requires that all images in a batch must have the same dimensions, and also UNet requires that the size of an image will be divisible by 16, we will apply <code>A.PadIfNeeded(min_height=512, min_width=512, border_mode=cv2.BORDER_CONSTANT)</code>. That augmentation will pad image borders with zeros so the image size will become 512x512 pixels.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1></a><a href=#__codelineno-33-1><span class=linenos data-linenos="1 "></span></a><span class=n>test_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2></a><a href=#__codelineno-33-2><span class=linenos data-linenos="2 "></span></a>    <span class=p>[</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3></a><a href=#__codelineno-33-3><span class=linenos data-linenos="3 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>PadIfNeeded</span><span class=p>(</span><span class=n>min_height</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>border_mode</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>BORDER_CONSTANT</span><span class=p>),</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4></a><a href=#__codelineno-33-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5></a><a href=#__codelineno-33-5><span class=linenos data-linenos="5 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6></a><a href=#__codelineno-33-6><span class=linenos data-linenos="6 "></span></a>    <span class=p>]</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7></a><a href=#__codelineno-33-7><span class=linenos data-linenos="7 "></span></a><span class=p>)</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8></a><a href=#__codelineno-33-8><span class=linenos data-linenos="8 "></span></a><span class=n>test_dataset</span> <span class=o>=</span> <span class=n>OxfordPetInferenceDataset</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>test_transform</span><span class=p>,)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1></a><a href=#__codelineno-34-1><span class=linenos data-linenos="1 "></span></a><span class=n>predictions</span> <span class=o>=</span> <span class=n>predict</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>test_dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></code></pre></div> <p>Since we received masks for padded images, we need to crop a part of the original image size from the padded mask.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1></a><a href=#__codelineno-35-1><span class=linenos data-linenos="1 "></span></a><span class=n>predicted_masks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2></a><a href=#__codelineno-35-2><span class=linenos data-linenos="2 "></span></a><span class=k>for</span> <span class=n>predicted_padded_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span> <span class=ow>in</span> <span class=n>predictions</span><span class=p>:</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3></a><a href=#__codelineno-35-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>cropped_mask</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>center_crop</span><span class=p>(</span><span class=n>predicted_padded_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span><span class=p>)</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4></a><a href=#__codelineno-35-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>predicted_masks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>cropped_mask</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1></a><a href=#__codelineno-36-1><span class=linenos data-linenos="1 "></span></a><span class=n>display_image_grid</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>predicted_masks</span><span class=o>=</span><span class=n>predicted_masks</span><span class=p>)</span>
</span></code></pre></div> <p><img alt=png src=../pytorch_semantic_segmentation_files/pytorch_semantic_segmentation_73_0.png></p> <h2 id=approach-3-use-original-images>Approach 3. Use original images.<a class=headerlink href=#approach-3-use-original-images title="Permanent link">&para;</a></h2> <p>We could also use original images without resizing or cropping them. However, there is a problem with this dataset. A few images in the dataset are so large that even with <code>batch_size=1</code>, they require more than 11Gb of GPU memory for training. So as a tradeoff, we will first apply the <code>A.LongestMaxSize(512)</code> augmentation that will ensure that an image's largest size is no more than 512 pixels. That augmentation will affect only 137 out of 7384 dataset images.</p> <p>Next will use <code>A.PadIfNeeded(min_height=512, min_width=512)</code> to ensure that all images in a batch will have size 512x512 pixels.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1></a><a href=#__codelineno-37-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>train_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2></a><a href=#__codelineno-37-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=p>[</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3></a><a href=#__codelineno-37-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>LongestMaxSize</span><span class=p>(</span><span class=mi>512</span><span class=p>),</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4></a><a href=#__codelineno-37-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>PadIfNeeded</span><span class=p>(</span><span class=n>min_height</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>512</span><span class=p>),</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5></a><a href=#__codelineno-37-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>ShiftScaleRotate</span><span class=p>(</span><span class=n>shift_limit</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>scale_limit</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>rotate_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6></a><a href=#__codelineno-37-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RGBShift</span><span class=p>(</span><span class=n>r_shift_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>g_shift_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>b_shift_limit</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7></a><a href=#__codelineno-37-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>RandomBrightnessContrast</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8></a><a href=#__codelineno-37-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9></a><a href=#__codelineno-37-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10></a><a href=#__codelineno-37-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>]</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11></a><a href=#__codelineno-37-11><span class=linenos data-linenos="11 "></span></a><span class=p>)</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12></a><a href=#__codelineno-37-12><span class=linenos data-linenos="12 "></span></a><span class=n>train_dataset</span> <span class=o>=</span> <span class=n>OxfordPetDataset</span><span class=p>(</span><span class=n>train_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>train_transform</span><span class=p>,)</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13></a><a href=#__codelineno-37-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14></a><a href=#__codelineno-37-14><span class=linenos data-linenos="14 "></span></a><span class=n>val_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15></a><a href=#__codelineno-37-15><span class=linenos data-linenos="15 "></span></a>    <span class=p>[</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16></a><a href=#__codelineno-37-16><span class=linenos data-linenos="16 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>LongestMaxSize</span><span class=p>(</span><span class=mi>512</span><span class=p>),</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17></a><a href=#__codelineno-37-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>PadIfNeeded</span><span class=p>(</span><span class=n>min_height</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>border_mode</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>BORDER_CONSTANT</span><span class=p>),</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18></a><a href=#__codelineno-37-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19></a><a href=#__codelineno-37-19><span class=linenos data-linenos="19 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20></a><a href=#__codelineno-37-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>]</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21></a><a href=#__codelineno-37-21><span class=linenos data-linenos="21 "></span></a><span class=p>)</span>
</span><span id=__span-37-22><a id=__codelineno-37-22 name=__codelineno-37-22></a><a href=#__codelineno-37-22><span class=linenos data-linenos="22 "></span></a><span class=n>val_dataset</span> <span class=o>=</span> <span class=n>OxfordPetDataset</span><span class=p>(</span><span class=n>val_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>val_transform</span><span class=p>,)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1></a><a href=#__codelineno-38-1><span class=linenos data-linenos="1 "></span></a><span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2></a><a href=#__codelineno-38-2><span class=linenos data-linenos="2 "></span></a>    <span class=s2>&quot;model&quot;</span><span class=p>:</span> <span class=s2>&quot;UNet11&quot;</span><span class=p>,</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3></a><a href=#__codelineno-38-3><span class=linenos data-linenos="3 "></span></a>    <span class=s2>&quot;device&quot;</span><span class=p>:</span> <span class=s2>&quot;cuda&quot;</span><span class=p>,</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4></a><a href=#__codelineno-38-4><span class=linenos data-linenos="4 "></span></a>    <span class=s2>&quot;lr&quot;</span><span class=p>:</span> <span class=mf>0.001</span><span class=p>,</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5></a><a href=#__codelineno-38-5><span class=linenos data-linenos="5 "></span></a>    <span class=s2>&quot;batch_size&quot;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6></a><a href=#__codelineno-38-6><span class=linenos data-linenos="6 "></span></a>    <span class=s2>&quot;num_workers&quot;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7></a><a href=#__codelineno-38-7><span class=linenos data-linenos="7 "></span></a>    <span class=s2>&quot;epochs&quot;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8></a><a href=#__codelineno-38-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1></a><a href=#__codelineno-39-1><span class=linenos data-linenos="1 "></span></a><span class=n>model</span> <span class=o>=</span> <span class=n>create_model</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2></a><a href=#__codelineno-39-2><span class=linenos data-linenos="2 "></span></a><span class=n>model</span> <span class=o>=</span> <span class=n>train_and_validate</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>train_dataset</span><span class=p>,</span> <span class=n>val_dataset</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></code></pre></div> <div class=codehilite><pre><span></span><code><span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.442</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:58&lt;00:00,  1.79it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.225</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:35&lt;00:00,  4.80it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>2</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.283</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:54&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>2</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.188</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.99it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.234</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.154</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.96it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.211</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.136</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.99it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>5</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.196</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>5</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.131</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.96it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>6</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.187</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>6</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.151</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.98it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.177</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.127</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.98it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.171</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.113</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.99it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>9</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.162</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:54&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>9</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.143</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.94it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>10</span><span class=o>.</span><span class=w> </span><span class=n>Train</span><span class=o>.</span><span class=w>      </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.157</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>750</span><span class=sr>/750 [06:53&lt;00:00,  1.81it/s</span><span class=o>]</span>
<span class=n>Epoch</span><span class=o>:</span><span class=w> </span><span class=mi>10</span><span class=o>.</span><span class=w> </span><span class=n>Validation</span><span class=o>.</span><span class=w> </span><span class=n>Loss</span><span class=o>:</span><span class=w> </span><span class=mf>0.115</span><span class=o>:</span><span class=w> </span><span class=mi>100</span><span class=o>%|</span><span class=err>██████████</span><span class=o>|</span><span class=w> </span><span class=mi>172</span><span class=sr>/172 [00:34&lt;00:00,  4.97it/s</span><span class=o>]</span>
</code></pre></div> <p>Next, we will use the same code that we were using in Approach 2 to make predictions.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1></a><a href=#__codelineno-40-1><span class=linenos data-linenos="1 "></span></a><span class=n>test_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2></a><a href=#__codelineno-40-2><span class=linenos data-linenos="2 "></span></a>    <span class=p>[</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3></a><a href=#__codelineno-40-3><span class=linenos data-linenos="3 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>PadIfNeeded</span><span class=p>(</span><span class=n>min_height</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>min_width</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>border_mode</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>BORDER_CONSTANT</span><span class=p>),</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4></a><a href=#__codelineno-40-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)),</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5></a><a href=#__codelineno-40-5><span class=linenos data-linenos="5 "></span></a>        <span class=n>ToTensorV2</span><span class=p>(),</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6></a><a href=#__codelineno-40-6><span class=linenos data-linenos="6 "></span></a>    <span class=p>]</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7></a><a href=#__codelineno-40-7><span class=linenos data-linenos="7 "></span></a><span class=p>)</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8></a><a href=#__codelineno-40-8><span class=linenos data-linenos="8 "></span></a><span class=n>test_dataset</span> <span class=o>=</span> <span class=n>OxfordPetInferenceDataset</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>test_transform</span><span class=p>,)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1></a><a href=#__codelineno-41-1><span class=linenos data-linenos="1 "></span></a><span class=n>predictions</span> <span class=o>=</span> <span class=n>predict</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>test_dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1></a><a href=#__codelineno-42-1><span class=linenos data-linenos="1 "></span></a><span class=n>predicted_masks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2></a><a href=#__codelineno-42-2><span class=linenos data-linenos="2 "></span></a><span class=k>for</span> <span class=n>predicted_padded_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span> <span class=ow>in</span> <span class=n>predictions</span><span class=p>:</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3></a><a href=#__codelineno-42-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>cropped_mask</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>center_crop</span><span class=p>(</span><span class=n>predicted_padded_mask</span><span class=p>,</span> <span class=n>original_height</span><span class=p>,</span> <span class=n>original_width</span><span class=p>)</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4></a><a href=#__codelineno-42-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>predicted_masks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>cropped_mask</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1></a><a href=#__codelineno-43-1><span class=linenos data-linenos="1 "></span></a><span class=n>display_image_grid</span><span class=p>(</span><span class=n>test_images_filenames</span><span class=p>,</span> <span class=n>images_directory</span><span class=p>,</span> <span class=n>masks_directory</span><span class=p>,</span> <span class=n>predicted_masks</span><span class=o>=</span><span class=n>predicted_masks</span><span class=p>)</span>
</span></code></pre></div> <p><img alt=png src=../pytorch_semantic_segmentation_files/pytorch_semantic_segmentation_83_0.png></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../pytorch_classification/ class="md-footer__link md-footer__link--prev" aria-label="Previous: PyTorch and Albumentations for image classification"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> PyTorch and Albumentations for image classification </div> </div> </a> <a href=../replay/ class="md-footer__link md-footer__link--next" aria-label="Next: Debugging an augmentation pipeline with ReplayCompose"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Debugging an augmentation pipeline with ReplayCompose </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href=https://twitter.com/albumentations target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg> </a> <a href=https://www.linkedin.com/company/100504475/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://discord.com/invite/AKPrrDYNAt target=_blank rel=noopener title=discord.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485 485 0 0 0 404.081 32.03a1.82 1.82 0 0 0-1.923.91 338 338 0 0 0-14.9 30.6 447.9 447.9 0 0 0-134.426 0 310 310 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.7 483.7 0 0 0-119.688 37.107 1.7 1.7 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.02 2.02 0 0 0 .765 1.375 487.7 487.7 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348 348 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321 321 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251 251 0 0 0 9.109-7.137 1.82 1.82 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.81 1.81 0 0 1 1.924.233 235 235 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.4 301.4 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391 391 0 0 0 30.014 48.815 1.86 1.86 0 0 0 2.063.7A486 486 0 0 0 610.7 405.729a1.88 1.88 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541M222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241m195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.instant.preview", "navigation.sections", "navigation.path", "navigation.prune", "navigation.expand", "navigation.indexes", "navigation.footer", "navigation.top", "search.suggest", "search.highlight", "search.share", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.56dfad97.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../js/extra.js></script> </body> </html>